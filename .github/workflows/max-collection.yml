name: 7-DAY MAX COLLECTION - Jan 5-11 Only

on:
  schedule:
    # EVERY 2 HOURS - MAXIMUM DATA COLLECTION
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  max-data-collection:
    # AUTO-STOPS AFTER 7 DAYS (84 runs)
    if: github.run_number <= 84
    
    runs-on: ubuntu-latest
    
    # PREVENT OVERLAPPING RUNS
    concurrency:
      group: week-blast-${{ github.ref }}
      cancel-in-progress: true
    
    steps:
    # STEP 0: CHECK IF 7 DAYS COMPLETE
    - name: Check collection period
      run: |
        echo "üìä Run number: ${{ github.run_number }}"
        if [ ${{ github.run_number }} -gt 84 ]; then
          echo "‚úÖ MISSION COMPLETE: 7 days of max collection finished!"
          echo "üéØ Total runs: 84 (12 per day √ó 7 days)"
          echo "üìà Total minutes used: ~1,344"
          echo "üìÅ Total records collected: ~18,144"
          echo ""
          echo "‚ö†Ô∏è  Please disable or modify this workflow."
          echo "   Change schedule back to: '0 2,8,14,20 * * *'"
          exit 0  # Graceful stop
        fi
        
        DAYS_DONE=$(( (${{ github.run_number }} - 1) / 12 ))
        RUNS_TODAY=$(( (${{ github.run_number }} - 1) % 12 + 1 ))
        echo "üìÖ Day $((DAYS_DONE + 1)) of 7 | Run $RUNS_TODAY/12 today"
    
    # STEP 1: CHECKOUT WITH FULL PERMISSIONS
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
    
    # STEP 2: FORCE SYNC WITH REMOTE
    - name: Force sync with remote
      run: |
        git fetch origin
        git reset --hard origin/main
        git clean -fd
    
    # STEP 3: SETUP PYTHON
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
    
    # STEP 4: RUN YOUR PYTHON SCRIPT
    - name: Run data collection
      run: |
        echo "üöÄ STARTING MAX COLLECTION RUN"
        echo "‚è∞ UTC Time: $(date -u +'%H:%M:%S')"
        echo "üìÖ Date: $(date -u +'%Y-%m-%d')"
        python test_collect.py
    
    # STEP 5: ARCHIVE WITH TIMESTAMP
    - name: Archive results with timestamp
      run: |
        # Date and time
        DATE=$(date -u +'%Y-%m-%d')
        DAY_NUM=$(date -u +'%d')
        TIME=$(date -u +'%H-%M-%S')
        FULL_TIMESTAMP="${DATE}_${TIME}"
        
        # Create day folder
        mkdir -p "WEEK-BLAST/day-${DAY_NUM}"
        
        # Archive with timestamp
        cp test_results.json "WEEK-BLAST/day-${DAY_NUM}/results_${FULL_TIMESTAMP}.json"
        cp test_summary.txt "WEEK-BLAST/day-${DAY_NUM}/summary_${FULL_TIMESTAMP}.txt"
        
        # Keep latest copy
        cp test_results.json "WEEK-BLAST/day-${DAY_NUM}/LATEST.json"
        cp test_summary.txt "WEEK-BLAST/day-${DAY_NUM}/LATEST.txt"
        
        # Update daily README
        echo "# üìä MAX COLLECTION - Day ${DAY_NUM} (${DATE})" > "WEEK-BLAST/day-${DAY_NUM}/README.md"
        echo "" >> "WEEK-BLAST/day-${DAY_NUM}/README.md"
        echo "## Collection Times Today:" >> "WEEK-BLAST/day-${DAY_NUM}/README.md"
        ls "WEEK-BLAST/day-${DAY_NUM}/"*.json 2>/dev/null | sort | while read file; do
          time=$(basename "$file" | cut -d'_' -f3- | cut -d'.' -f1)
          echo "- ${time}" >> "WEEK-BLAST/day-${DAY_NUM}/README.md"
        done || true
        
        # Update master summary
        if [ ! -f "WEEK-BLAST/7-DAY-SUMMARY.md" ]; then
          echo "# üöÄ 7-DAY MAX COLLECTION SUMMARY" > "WEEK-BLAST/7-DAY-SUMMARY.md"
          echo "## January 5-11, 2026" >> "WEEK-BLAST/7-DAY-SUMMARY.md"
          echo "" >> "WEEK-BLAST/7-DAY-SUMMARY.md"
          echo "| Day | Date | Collections | Total Records |" >> "WEEK-BLAST/7-DAY-SUMMARY.md"
          echo "|-----|------|------------|---------------|" >> "WEEK-BLAST/7-DAY-SUMMARY.md"
        fi
        
        # Count today's files
        TODAY_COUNT=$(ls "WEEK-BLAST/day-${DAY_NUM}/"results_*.json 2>/dev/null | wc -l || echo "0")
        TODAY_RECORDS=$((TODAY_COUNT * 216))
        
        # Update or add day entry
        if grep -q "| ${DAY_NUM} | ${DATE} |" "WEEK-BLAST/7-DAY-SUMMARY.md"; then
          sed -i "s/| ${DAY_NUM} | ${DATE} |.*/| ${DAY_NUM} | ${DATE} | ${TODAY_COUNT} | ${TODAY_RECORDS} |/" "WEEK-BLAST/7-DAY-SUMMARY.md"
        else
          echo "| ${DAY_NUM} | ${DATE} | ${TODAY_COUNT} | ${TODAY_RECORDS} |" >> "WEEK-BLAST/7-DAY-SUMMARY.md"
        fi
    
    # STEP 6: CONFIGURE GIT
    - name: Configure Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
    
    # STEP 7: CHECK FOR CHANGES
    - name: Check for changes
      id: check_changes
      run: |
        if git status --porcelain | grep -q "."; then
          echo "has_changes=true" >> $GITHUB_OUTPUT
        else
          echo "has_changes=false" >> $GITHUB_OUTPUT
        fi
    
    # STEP 8: COMMIT AND PUSH
    - name: Commit and push
      if: steps.check_changes.outputs.has_changes == 'true'
      run: |
        git add .
        git commit -m "üöÄ MAX COLLECTION: Day $(date -u +'%d') - $(date -u +'%H:%M UTC') [Run ${{ github.run_number }}/84]"
        git push origin main --force-with-lease
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # STEP 9: COLLECTION STATISTICS
    - name: Collection statistics
      run: |
        echo "üìà COLLECTION STATISTICS"
        echo "========================"
        echo "Run: ${{ github.run_number }}/84"
        echo "Records this run: ~216"
        echo "Total records so far: ~$(( (${{ github.run_number }} - 1) * 216 ))"
        echo "Minutes used: ~$(( ${{ github.run_number }} * 16 ))"
    
    # STEP 10: FINAL RUNS WARNING
    - name: Final runs warning
      if: github.run_number >= 80
      run: |
        echo "‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è FINAL RUNS WARNING ‚ö†Ô∏è ‚ö†Ô∏è ‚ö†Ô∏è"
        echo ""
        echo "Only $((84 - ${{ github.run_number }} + 1)) runs remaining!"
        echo ""
        echo "After run #84, this workflow will auto-stop."
        echo "To continue collecting data, you must:"
        echo "1. Edit this workflow file"
        echo "2. Change line 9 to: '0 2,8,14,20 * * *'"
        echo "3. Remove or modify the 'if: github.run_number <= 84' condition"
